<?php

namespace App\Services\ExcelServices;

use App\DTO\OivKtDTO;
use App\Models\User;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;

class OivKtDataService
{
    private array $stages = [
        // Начальные этапы (первые 13)
        'Определение потребности',
        'Разработка концепции',
        'Бюджетная оценка',
        'Принятие решения о включении объекта в АИП (штаб градполитики)',
        'ППМ (708-ПП/ППТ)',
        'Корректировка санитарно-защитной зоны (при необходимости)',
        'Получение Градостроительного плана земельного участка (ГПЗУ)',
        'Разработка и согласование задания на проектирование и строительство',
        'Разработка проектной документации',
        'Разработка рабочей документации',
        'Проведение конкурсных процедур и подписание договора генподряда',
        'Разработка и согласование архитектурно-планировочных решений (АПР)',
        'Разработка и согласование архитектурно-градостроительных решений (АГР)',

        // Оформление ТУ (6 этапов)
        'Оформление ТУ: теплосеть',
        'Оформление ТУ: водоснабжение',
        'Оформление ТУ: Х/Б канализация',
        'Оформление ТУ: ливневая канализация',
        'Оформление ТУ: электроснабжение',
        'Оформление ТУ: сети связи',

        // Заключение СКП (7 этапов)
        'Соглашение о компенсации потерь по выносу из пятна застройки теплосети',
        'Соглашение о компенсации потерь по выносу из пятна застройки сети водоснабжения',
        'Соглашение о компенсации потерь по выносу из пятна застройки сети водоотведения',
        'Соглашение о компенсации потерь по выносу из пятна застройки по сети водоотведения поверхностных сточных вод',
        'Соглашение о компенсации потерь по выносу из пятна застройки сети газоснабжения (при наличии)',
        'Соглашение о компенсации потерь по выносу из пятна застройки сети электроснабжения',
        'Соглашение о компенсации потерь по выносу из пятна застройки сети связи',

        // Заключение договоров (7 этапов)
        'Договор о подключении (технологическом присоединении) к сетям теплоснабжения',
        'Договор о подключении (технологическом присоединении) к сетям водоснабжения',
        'Договор о подключении (технологическом присоединении) к централизованной сетям водоотведения',
        'Договор о подключении (технологическом присоединении) к централизованным сетям водоотведения поверхностных сточных вод',
        'Договор о подключении (технологическом присоединении) к сетям электроснабжения',
        'Договор о подключении (технологическом присоединении) к газораспределительным сетям',
        'Договор/Технические условия о подключении к сетям связи',

        // Этапы без заголовков в первой строке
        'Получение положительного заключения Мосгосэкспертизы',
        'Отселение домов в пятне застройки',

        // Вынос инженерных систем (7 этапов)
        'Вынос сетей: теплосеть',
        'Вынос сетей: водоснабжение',
        'Вынос сетей: Х/Б канализация',
        'Вынос сетей: ливневая канализация',
        'Вынос сетей: газоснабжение',
        'Вынос сетей: электроснабжение',
        'Вынос сетей: сети связи',

        // Этапы без заголовков в первой строке
        'Снос домов в пятне застройки',
        'Снос нежилых объектов в пятне застройки',
        'Вырубка зеленых насаждений',
        'Обустройство строительной площадки',
        'Организация движения согласно ПОДД на период строительства',
        'Получение разрешения на строительство',
        'Устройство ТПМК (сборка и подготовка ТПМК)',
        'Проходка тоннелей с монтажем ж/б обделки',
        'Порубочный билет (при необходимости)',
        'Устройство подземной части',
        'Устройство надземной части',

        // Устройство инженерных систем (6 этапов)
        'Теплосеть',
        'Водоснабжение',
        'Х/Б канализация',
        'Ливневая канализация',
        'Электроснабжение',
        'Слаботочные сети',

        // Этапы без заголовков в первой строке
        'Отделочные работы',
        'Благоустройство территории',
        'Корректировка архитектурно-планировочных решений (АПР)',
        'Повторное заключение экспертизы проектной документации',
        'Внесение изменений в разрешение на строительства',
        'Получение заключения о соответствии (ЗОС)',
        'Решение о присвоении адреса',
        'Получение разрешения на ввод объекта в эксплуатацию (РВ)',
        'Оформление и подписание КС-11',
        'Постановка на кадастровый учет',
        'Передача под заселение'
    ];

    public function getKtData($objects, User $user): array
    {
        $data = [];

        foreach ($objects as $index => $object) {
            $objectData = $object->toArray();

            // Создаем DTO с этапами
            $dto = OivKtDTO::fromArray($objectData, $user, $this->stages);

            // Получаем данные этапов из control_points
            $controlPoints = $objectData['control_points'] ?? [];

            // Преобразуем контрольные точки в ассоциативный массив по названию этапа
            $pointsByStage = [];
            foreach ($controlPoints as $point) {
                if (isset($point['control_point_library']['name'])) {
                    $stageName = $point['control_point_library']['name'];
                    $normalizedStageName = mb_strtolower(trim($stageName), 'UTF-8');
                    $pointsByStage[$normalizedStageName] = $point;
                }
            }

            // Добавляем данные для всех этапов
            foreach ($this->stages as $stage) {
                $normalizedStage = mb_strtolower(trim($stage), 'UTF-8');

                $stageData = [
                    'plan_start' => '',
                    'fact_start' => '',
                    'plan_end' => '',
                    'fact_end' => '',
                    'progress' => ''
                ];

                // Если есть данные для этого этапа, заполняем их
                if (isset($pointsByStage[$normalizedStage])) {
                    $point = $pointsByStage[$normalizedStage];
                    $stageData = [
                        'plan_start' => $point['plan_start_date'] ?? '',
                        'fact_start' => $point['fact_start_date'] ?? '',
                        'plan_end' => $point['plan_finish_date'] ?? '',
                        'fact_end' => $point['fact_finish_date'] ?? '',
                        'progress' => $point['progress'] ?? ''
                    ];
                }

                $dto->setStageData($stage, $stageData);
            }

            $data[] = $dto;
        }

        return $data;
    }

    public function getStages(): array
    {
        return $this->stages;
    }
}
