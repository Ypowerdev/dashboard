<?php

namespace App\Console\Commands;

use Illuminate\Console\Command;
use Illuminate\Support\Facades\File;

class CountControlPointsInJson extends Command
{
    /**
     * The name and signature of the console command.
     *
     * @var string
     */
    protected $signature = 'count:CP';

    /**
     * Описание команды
     *
     * @var string
     */
    protected $description = 'DASHBORDSTROIMO-23 Сделать сверку предоставленных КТ и JSON объектов с данными';

    /**
     * Список названий КТ
     *
     * @var array
     */
    protected $keywords = [
        'ППМ (708-ПП/ППТ)',
        'ГПЗУ',
        'Разработка и согласование ТЗ',
        'Разработка и согласование квартирографии',
        'Проведение конкурсных процедур и подписание договора',
        'Разработка и согласование АПР',
        'Разработка и согласование АГР',
        'Заключение СКП',
        'Теплосеть (ЦТП)',
        'Теплосеть (сети)',
        'Водоснабжение',
        'Х/Б канализация',
        'Ливневая канализация',
        'Газоснабжение',
        'Электроснабжение (ТП)',
        'Электроснабжение (сети)',
        'Сети связи (КП МПТЦ)',
        'Договор ТП',
        'Теплосеть',
        'Водоснабжение',
        'Х/Б канализация',
        'Ливневая канализация',
        'Электроснабжение',
        'Сети связи',
        'Получение заключения МГЭ',
        'Отселение домов в пятне застройки',
        'Вынос инженерных систем из пятна застройки (ЦТП/ТП/сети)',
        'Теплосеть (ЦТП)',
        'Теплосеть (сети)',
        'Водоснабжение',
        'Х/Б канализация',
        'Ливневая канализация',
        'Газоснабжение',
        'Электроснабжение (ТП)',
        'Электроснабжение (сети)',
        'Сети связи (КП МПТЦ)',
        'Снос домов в пятне застройки',
        'Снос нежилых объектов в пятне застройки',
        'Получение разрешения на строительство',
        'Устройство подземной части',
        'Устройство надземной части',
        'Устройство инженерных систем',
        'Теплосеть',
        'Водоснабжение',
        'Х/Б канализация',
        'Ливневая канализация',
        'Электроснабжение',
        'Сети связи',
        'Отделочные работы',
        'Благоустройство территории',
        'Корректировка ГПЗУ',
        'Корректировка МГЭ',
        'Корректировка РС',
        'Получение ЗОС',
        'Получение РВ',
        'Постановка на кадастровый учет',
        'Передача под заселение',
    ];

    /**
     * Основной метод выполнения команды
     *
     * @return int
     */
    public function handle()
    {
        // Путь к папке с файлами
        $path = storage_path('app/json_samples/11_check');

        // Массив для хранения результатов
        $results = array_fill_keys($this->keywords, 0);

        // Файл для записи информации о строках без "КОНТРТОЧКА"
        $outputFile = storage_path('app/missing_control_points.txt');
        file_put_contents($outputFile, ''); // Очищаем файл перед записью

        // Перебираем файлы в папке
        $files = File::allFiles($path);
        foreach ($files as $file) {
            $filePath = $file->getPathname();
            $lines = file($filePath); // Читаем файл построчно

            // Получаем родительские директории (два уровня вверх)
            $parentDir = basename(dirname($filePath)); // Родительская директория (первый уровень)
            $grandParentDir = basename(dirname(dirname($filePath))); // Родительская директория (второй уровень)

            foreach ($lines as $lineNumber => $line) {
                // Перебираем ключевые слова
                foreach ($this->keywords as $keyword) {
                    // Проверяем, содержится ли ключевое слово в строке
                    if (stripos($line, $keyword) !== false) {
                        // Увеличиваем счетчик упоминаний
                        $results[$keyword]++;

                        // Проверяем, есть ли в строке "КОНТРТОЧКА"
                        if (stripos($line, 'КОНТРТОЧКА') === false && stripos($line, 'null') === false) {
                            // Записываем информацию в файл
                            $logMessage = sprintf(
                                "%s - найден в файле %s (родительские директории: %s/%s) на строке %d\n",
                                $line,
                                $file->getFilename(),
                                $grandParentDir,
                                $parentDir,
                                $lineNumber + 1
                            );
                            file_put_contents($outputFile, $logMessage, FILE_APPEND);
                        }
                    }
                }
            }
        }

        // Выводим результаты
        foreach ($results as $keyword => $count) {
            $this->info("\"$keyword\" - \"$count\" упоминаний");
        }

        $this->info("Информация о строках без 'КОНТРТОЧКА' сохранена в файл: $outputFile");
    }
}